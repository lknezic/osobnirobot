# Project Instructions

## Project Context
InstantWorker (formerly OsobniRobot) — AI employee marketplace. Next.js 14 App Router, TypeScript, Supabase (auth + DB), Stripe subscriptions, Docker containers via OpenClaw. Deployed on Vercel (frontend) + Hetzner (orchestrator/containers).

## Commands
- Dev: `npm run dev`
- Build: `npm run build`
- Lint: `npm run lint`
- No test or typecheck scripts yet — run `npx tsc --noEmit` for typecheck.

## Architecture
- app/page.tsx - Landing page (hero, skills, pricing)
- app/auth/ - Login (magic link + Google OAuth) and callback
- app/onboarding/page.tsx - Multi-step wizard (plan → skills → name/tone → launch)
- app/dashboard/page.tsx - Main dashboard (Chat/Browser/Settings tabs)
- app/api/subscribe/ - Email waitlist (rate-limited)
- app/api/stripe/ - Checkout session creation + webhook handler
- app/api/containers/ - Provision, status, restart endpoints (talk to orchestrator)
- app/docker/ - OpenClaw config + container entrypoint script
- lib/supabase-server.ts - Server Supabase client (cookies, use in API routes)
- lib/supabase-browser.ts - Browser Supabase client (use in "use client" components)
- lib/translations.ts - i18n strings (landing), lib/dash-translations.ts (dashboard)
- middleware.ts - Auth protection for /dashboard, /onboarding, /auth/login
- worker-templates/ - Per-worker SOUL.md, SKILL.md, HEARTBEAT.md, config/
- supabase-migration-v5.sql - DB schema (profiles + container_events)
- app/orchestrator/ - Separate orchestrator service (excluded from tsconfig)

## Code Style
- TypeScript strict mode, path alias @/*
- Dark theme only — custom CSS vars (--bg, --text, --accent, etc.) in globals.css
- No component library — pure Tailwind + inline styles
- No default exports pattern enforced, but pages use default export (Next.js requirement)

## Verification
- YOU MUST run `npm run lint` and `npx tsc --noEmit` before considering any task complete.
- If lint or typecheck fails, fix automatically.
- After fixing a bug, re-run all checks.

## Constraints
- Keep changes minimal — don't refactor unrelated code.
- Don't add features, optimizations, or abstractions that weren't requested.
- Prefer the simplest solution that works correctly.
- Check if similar functionality already exists before writing new code.

## Approval Levels
- Auto: style fixes, bug fixes, lint fixes
- Inform: new files, refactors within a module
- Ask first: DB schema changes, Stripe/payment changes, API contract changes, new dependencies

## Gotchas
- Auth: Use createSupabaseServer() in API routes, createSupabaseBrowser() in client components. Don't mix them.
- Middleware refreshes sessions on every request — don't bypass it.
- Container provisioning flow: onboarding → /api/containers/provision → orchestrator (port 3500) → Docker. Ports saved to Supabase profiles.
- Dashboard iframes: Chat uses OpenClaw gateway port, Browser uses noVNC port. Both proxied via *.gw.instantworker.ai / *.vnc.instantworker.ai.
- app/orchestrator/ is excluded from tsconfig — it's a separate service, don't typecheck it with the main app.
- Rate limiting on /api/subscribe is in-memory (resets on deploy) — not persistent.
- Stripe webhook route exists but handler is mostly empty — careful when touching payments.
- Environment variables: ORCHESTRATOR_URL + ORCHESTRATOR_SECRET for container API calls. Never expose SUPABASE_SERVICE_ROLE_KEY to client.
- Worker templates use SOUL.md/SKILL.md/HEARTBEAT.md convention — follow the x-commenter example.

## OpenClaw Reference

OpenClaw is the AI agent gateway that powers each worker container. Docs: https://docs.openclaw.ai

### Config (openclaw.json / JSON5)
- Located at `~/.openclaw/openclaw.json` inside each container (generated by entrypoint.sh at startup).
- JSON5 format (comments + trailing commas allowed). Unknown keys cause gateway to refuse to start.
- Config is hot-reloaded — gateway watches the file, no restart needed for most changes.
- Use `$include` to split config: `agents: { $include: "./agents.json5" }`.
- Environment variables override config file values, which override built-in defaults.

### Key Config Sections
```json5
{
  "gateway": {
    "port": 18789,           // Default port
    "bind": "lan",           // "loopback" | "lan" | "tailnet" | "auto" | "custom"
    "auth": {
      "mode": "token",       // "token" | "none"
      "token": "..."
    },
    "controlUi": {
      "enabled": true,
      "allowInsecureAuth": true  // Required when bind=lan
    },
    "trustedProxies": ["172.17.0.0/16", "127.0.0.1"]
  },
  "models": {
    "providers": {
      "<provider-name>": {
        "apiKey": "...",
        "baseUrl": "...",
        "api": "openai-responses",  // Optional: API format
        "models": [{"id": "model-id", "name": "Display Name"}]
      }
    }
  },
  "agents": {
    "defaults": {
      "workspace": "/home/node/.openclaw/workspace",
      "models": ["model-id"]  // Allowlist for /model command
    },
    "list": [{ "id": "...", "workspace": "..." }],  // Multi-agent
    "bindings": {}  // Map conversations to agents
  },
  "channels": {
    "whatsapp": { "allowFrom": [...], "groups": {...} },
    "telegram": { "allowFrom": [...], "groups": {...} },
    "discord":  { "guilds": {...} }
  },
  "identity": {
    "name": "...",
    "theme": "...",
    "emoji": "...",
    "avatar": "..."
  },
  "browser": {
    "enabled": true,
    "defaultProfile": "...",
    "profiles": {
      "<name>": {
        "cdpUrl": "..."        // Remote CDP (e.g. browserless, sidecar)
      }
    },
    "executablePath": "..."    // Override auto-detection
  },
  "sandbox": {
    "mode": "non-main",
    "scope": "session",
    "docker": { "image": "...", "network": "...", "readOnlyRoot": true }
  },
  "skills": {
    "load": {
      "extraDirs": ["/path/to/skills"]  // Extra skill folders (lowest precedence)
    }
  },
  "messages": { "responsePrefix": "auto" }
}
```

### Gateway Bind Modes
- `loopback` — 127.0.0.1 only, nginx proxies LAN traffic (most secure)
- `lan` — 0.0.0.0, direct access (what we use — containers are on internal Docker network)
- `tailnet` / `auto` / `custom` — other options

### Browser in Containers
- Each container runs Xvfb (virtual display :99) → x11vnc (VNC on port 5900) → websockify/noVNC (web VNC on port 6080).
- Chromium uses `DISPLAY=:99` for GUI rendering.
- Browser profile is isolated per container (separate user-data dir).
- For remote CDP: set `browser.profiles.<name>.cdpUrl` to attach to external Chromium (e.g. browserless.io).
- Important: Ubuntu snap Chromium breaks CDP — use apt or Playwright install instead.

### Heartbeat (Cron)
- Configured in `agents.defaults.heartbeat`: `{ "every": "30m", "target": "..." }`.
- HEARTBEAT.md in workspace tells the agent what to do on each cron tick.
- Our workers use heartbeat for periodic tasks (check targets, post content, etc.).

### Skills
- Workspace skills: files in `workspace/skills/` folder.
- Extra dirs: `skills.load.extraDirs` in config.
- 700+ built-in skills available — high-risk ones (exec, browser) need explicit enable.

### Security Best Practices
- Container security: CapDrop ALL, add only SYS_ADMIN (Chrome sandbox), no-new-privileges.
- DM policy: use pairing or allowlist, never "open" in production.
- LiteLLM proxy mode: containers never see real API keys.
- Run `openclaw doctor --fix` on startup (we do this in entrypoint.sh).
- `openclaw security audit` for config review.

### Container Architecture (Our Setup)
- Image: `instantworker/worker:latest` (based on `alpine/openclaw:latest` + VNC + Chromium)
- Internal ports: 18789 (gateway), 6080 (noVNC) — mapped to host port ranges
- Host port ranges: 20000-21999 (gateway), 22000-23999 (noVNC)
- Container naming: `iw-{employeeId[:12]}`
- Resource limits: 2GB RAM, 2 CPU cores, 256MB shared memory, 512 max PIDs
- Restart policy: unless-stopped
- Workspace mounted read-only from host at `/defaults/workspace`
- Shared team volume at `{workspace}/shared`
- Config generated dynamically from env vars by entrypoint.sh

### Container Environment Variables
```
GATEWAY_TOKEN        — UUID token for gateway API auth
OPENCLAW_GATEWAY_PORT — Internal gateway port (always 18789)
NOVNC_PORT           — Internal noVNC port (always 6080)
ASSISTANT_NAME       — Worker display name
WORKER_TYPE          — Template type (x-commenter, x-tweet-writer, etc.)
DISPLAY              — Virtual display (:99)
LITELLM_URL          — LiteLLM proxy URL (preferred)
LITELLM_KEY          — LiteLLM proxy key
GOOGLE_AI_KEY        — Direct API key (fallback)
ANTHROPIC_API_KEY    — Direct API key (fallback)
```

### Workspace Structure Inside Container
```
/home/node/.openclaw/workspace/
├── SOUL.md              — Worker personality + instructions
├── HEARTBEAT.md         — Scheduled task instructions
├── LEARNING-PROTOCOL.md — Auto-appended learning behavior
├── SKILLMAKER.md        — Hidden skill for autonomous learning
├── config/              — targets.json, company-config.json, rules.md, brand-voice.md
├── skills/              — Per-skill instruction files
├── docs/                — Editable by user (company, competitors, audience, etc.)
├── reference/           — Copywriting playbooks + user-uploaded files
├── memory/              — Worker memory (research, questions, suggestions, daily logs)
├── content/             — Content queue (drafts pending approval)
└── shared/              — Team shared knowledge (via Docker volume)
```

### Orchestrator Endpoints (Hetzner, port 3500)
```
POST   /api/containers/provision          — Create new container
POST   /api/containers/restart            — Restart container
GET    /api/containers/status/:id         — Running status + ports
GET    /api/containers/status-detail/:id  — Uptime, health, pending questions
GET/POST/DELETE /api/containers/files/:id — Manage reference files
GET/POST/PUT/DELETE /api/containers/docs/:id/:filename — Manage editable docs
GET    /api/containers/memory/:id         — Worker memory
GET    /api/containers/activity/:id       — Heartbeat logs + daily activity
GET    /api/containers/content/:id        — Content queue
POST   /api/containers/content/:id/approve|reject — Content approval
GET    /api/containers/summary/:id        — Dashboard stats
GET    /api/containers/improvements       — Harvest suggestions from all workers
GET    /health                            — Health check (no auth)
```
All routes (except /health) require `x-orchestrator-secret` header.

### Docker Build & Deploy (Hetzner)
```bash
# On Hetzner server:
cd /opt/instantworker

# 1. Pull latest code
git pull origin main

# 2. Build the image
docker build -t instantworker/worker:latest -f app/docker/Dockerfile .

# 3. Restart orchestrator to pick up new templates
pm2 restart orchestrator

# 4. Rolling restart of running containers (optional)
# The orchestrator health check will restart unhealthy containers automatically.
# To force-restart a specific worker:
curl -X POST http://localhost:3500/api/containers/restart \
  -H "x-orchestrator-secret: $ORCHESTRATOR_SECRET" \
  -H "Content-Type: application/json" \
  -d '{"employeeId": "..."}'
```

### Troubleshooting
- Gateway won't start: check `openclaw.json` for unknown keys or invalid values (strict schema).
- noVNC blank: verify Xvfb is running (`ps aux | grep Xvfb`), check x11vnc logs at `/tmp/x11vnc.log`.
- Chrome crashes: check shared memory size (needs 256MB+), verify SYS_ADMIN capability.
- Container immediately exits: check `docker logs iw-{id}` for entrypoint errors.
- Port conflicts: orchestrator allocates from ranges — check for stale containers holding ports.
- LiteLLM 401: verify LITELLM_KEY matches the proxy's master key.
- Hot reload not working: only some config changes hot-reload — gateway/port changes need restart.

### OpenClaw Docs (key pages)
- Configuration overview: https://docs.openclaw.ai/gateway/configuration
- Configuration reference: https://docs.openclaw.ai/gateway/configuration-reference
- Configuration examples: https://docs.openclaw.ai/gateway/configuration-examples
- Security: https://docs.openclaw.ai/gateway/security
- Skills: https://docs.openclaw.ai/tools/skills
- Browser: https://docs.openclaw.ai/tools/browser
- CLI reference: https://docs.openclaw.ai/cli
