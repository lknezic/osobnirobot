# InstantWorker - Caddy Reverse Proxy
# Wildcard TLS via Cloudflare DNS challenge
#
# Requires: CLOUDFLARE_API_TOKEN env var with Zone:DNS:Edit permissions
# Install: sudo caddy add-package github.com/caddy-dns/cloudflare

# Global options
{
	acme_dns cloudflare {env.CLOUDFLARE_API_TOKEN}
}

# Gateway subdomains: {port}.gw.instantworker.ai -> localhost:{port}
# Container gateway (OpenClaw) runs on ports 20000-21999
*.gw.instantworker.ai {
	tls {
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
	}

	# Extract port number from subdomain using map
	# labels are 0-indexed from right: ai=0, instantworker=1, gw=2, PORT=3
	map {labels.3} {gw_port} {
		~^(\d+)$ "${1}"
	}

	# Only proxy if port was extracted
	@has_port expression `{gw_port} != ""`
	handle @has_port {
		# Remove X-Frame-Options to allow iframe embedding on Vercel
		header -X-Frame-Options
		header -Content-Security-Policy
		header Access-Control-Allow-Origin "https://instantworker.ai"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization"
		header Access-Control-Allow-Credentials "true"

		# Caddy v2 handles WebSocket upgrades automatically.
		# Do NOT set header_up Connection/Upgrade â€” they resolve to empty
		# strings over HTTP/2 and break WebSocket.
		reverse_proxy localhost:{gw_port}
	}

	handle {
		respond "Invalid port" 400
	}
}

# VNC subdomains: {port}.vnc.instantworker.ai -> localhost:{port}
# Container noVNC runs on ports 22000-23999
*.vnc.instantworker.ai {
	tls {
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
	}

	# labels are 0-indexed from right: ai=0, instantworker=1, vnc=2, PORT=3
	map {labels.3} {vnc_port} {
		~^(\d+)$ "${1}"
	}

	@has_port expression `{vnc_port} != ""`
	handle @has_port {
		header -X-Frame-Options
		header -Content-Security-Policy
		header Access-Control-Allow-Origin "https://instantworker.ai"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization"
		header Access-Control-Allow-Credentials "true"

		# Caddy v2 handles WebSocket upgrades automatically.
		reverse_proxy localhost:{vnc_port}
	}

	handle {
		respond "Invalid port" 400
	}
}
